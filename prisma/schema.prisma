generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model categories {
  id                       Int                        @id @default(autoincrement())
  name                     String                     @unique @db.VarChar(255)
  description              String?                    @db.Text
  robots                   robots[]
  tournament_registrations tournament_registrations[]
  tournament_results       tournament_results[]
  news_categories          news_categories[]
}

model club_owners {
  user_id              Int       @id
  dni                  String    @unique @db.VarChar(20)
  is_approved          Boolean?  @default(false)
  approved_by_admin_id Int?
  approved_at          DateTime? @db.Timestamp(0)

  user users @relation("ClubOwnerUser", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  approvedByAdmin users? @relation("ClubOwnerApprovedByAdmin", fields: [approved_by_admin_id], references: [id], onUpdate: NoAction)

  @@index([approved_by_admin_id])
}

model clubs {
  id             Int           @id @default(autoincrement())
  owner_id       Int
  name           String        @db.VarChar(255)
  fiscal_address String        @db.Text
  logo           String?       @db.Text
  created_at     DateTime?     @default(now()) @db.Timestamp(0)
  updated_at     DateTime?     @default(now()) @db.Timestamp(0)
  is_approved    Boolean       @default(false)
  approved_by    Int?
  approvedAt     DateTime?
  competitors    competitors[]

  owner           users  @relation("UserOwnedClubs", fields: [owner_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  approvedByAdmin users? @relation("ClubApprovedBy", fields: [approved_by], references: [id], onUpdate: NoAction)

  @@index([owner_id])
}

model competitors {
  user_id                  Int                        @id
  club_id                  Int
  is_approved              Boolean?                   @default(false)
  approved_by              Int?
  approved_at              DateTime?                  @db.Timestamp(0)
  created_at               DateTime?                  @default(now()) @db.Timestamp(0)
  updated_at               DateTime?                  @default(now()) @db.Timestamp(0)
  robots                   robots[]
  judge_scores             judge_scores[]
  rankings                 rankings[]
  tournament_registrations tournament_registrations[]
  tournament_results       tournament_results[]

  user users @relation("CompetitorUser", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  club clubs @relation(fields: [club_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  approvedBy users? @relation("CompetitorApprovedBy", fields: [approved_by], references: [id], onUpdate: NoAction)

  @@index([approved_by])
  @@index([club_id])
}

model judge_scores {
  id            Int      @id @default(autoincrement())
  tournament_id Int
  judge_id      Int
  competitor_id Int
  round_number  Int
  total_score   Decimal? @db.Decimal(5, 2)

  tournaments tournaments @relation(fields: [tournament_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  judges judges @relation(fields: [judge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  competitors competitors @relation(fields: [competitor_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([competitor_id])
  @@index([judge_id])
  @@index([tournament_id])
}

model judges {
  id                       Int                        @id @default(autoincrement())
  user_id                  Int
  specialization           String?                    @db.VarChar(255)
  is_active                Boolean?                   @default(true)
  created_at               DateTime?                  @default(now()) @db.Timestamp(0)
  judge_scores             judge_scores[]
  tournament_judges        tournament_judges[]
  tournament_registrations tournament_registrations[]

  user users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
}

model news {
  id              Int               @id @default(autoincrement())
  title           String            @db.VarChar(255)
  content         String            @db.Text
  image_url       String?           @db.Text
  published_by    Int
  source_name     String?           @db.VarChar(255)
  source_link     String?           @db.Text
  source_logo_url String?           @db.Text
  created_at      DateTime          @default(now()) @db.Timestamp(0)
  updated_at      DateTime          @updatedAt @db.Timestamp(0)
  categories      news_categories[]

  publishedBy users @relation(fields: [published_by], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([published_by])
}

model news_categories {
  id          Int @id @default(autoincrement())
  news_id     Int
  category_id Int

  news news @relation(fields: [news_id], references: [id], onDelete: Cascade)

  categories categories @relation(fields: [category_id], references: [id], onDelete: Cascade)

  @@unique([news_id, category_id])
  @@index([news_id])
  @@index([category_id])
}

model password_resets {
  id         Int       @id @default(autoincrement())
  user_id    Int
  token      String    @db.VarChar(255)
  created_at DateTime? @default(now()) @db.Timestamp(0)

  users users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id])
}

model rankings {
  id               Int       @id @default(autoincrement())
  tournament_id    Int
  competitor_id    Int
  robot_id         Int
  total_score      Decimal?  @default(0.00) @db.Decimal(7, 2)
  ranking_position Int?
  last_updated     DateTime? @default(now()) @db.Timestamp(0)

  tournaments tournaments @relation(fields: [tournament_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  competitors competitors @relation(fields: [competitor_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  robots robots @relation(fields: [robot_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([competitor_id])
  @@index([robot_id])
  @@index([tournament_id])
}

model robots {
  id             Int                @id @default(autoincrement())
  name           String             @db.VarChar(255)
  status         robot_status       @default(active)
  control_type   robot_control_type
  wins           Int                @default(0)
  losses         Int                @default(0)
  matches_played Int                @default(0)
  category_id    Int
  competitor_id  Int
  created_at     DateTime           @default(now()) @db.Timestamp(0)
  updated_at     DateTime           @updatedAt @db.Timestamp(0)

  rankings                 rankings[]
  tournament_registrations tournament_registrations[]
  tournament_results       tournament_results[]

  categories  categories  @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  competitors competitors @relation(fields: [competitor_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category_id])
  @@index([competitor_id])
  @@index([status])
}

model tournament_judges {
  id            Int @id @default(autoincrement())
  tournament_id Int
  judge_id      Int

  tournaments tournaments @relation(fields: [tournament_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  judges judges @relation(fields: [judge_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([judge_id])
  @@index([tournament_id])
}

model tournament_registrations {
  id                Int                                         @id @default(autoincrement())
  tournament_id     Int
  competitor_id     Int
  robot_id          Int
  category_id       Int
  is_approved       Boolean?                                    @default(false)
  assigned_judge_id Int?
  validation_status tournament_registrations_validation_status? @default(pending)
  validation_notes  String?                                     @db.Text
  validated_at      DateTime?                                   @db.Timestamp(0)
  registered_at     DateTime?                                   @default(now()) @db.Timestamp(0)

  tournaments tournaments @relation(fields: [tournament_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  competitors competitors @relation(fields: [competitor_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  robots robots @relation(fields: [robot_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  categories categories @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  judges judges? @relation(fields: [assigned_judge_id], references: [id], onUpdate: NoAction)

  @@index([assigned_judge_id])
  @@index([category_id])
  @@index([competitor_id])
  @@index([robot_id])
  @@index([tournament_id])
}

model tournament_results {
  id            Int       @id @default(autoincrement())
  tournament_id Int
  competitor_id Int
  robot_id      Int
  category_id   Int
  score         Decimal?  @db.Decimal(5, 2)
  position      Int?
  notes         String?   @db.Text
  created_at    DateTime? @default(now()) @db.Timestamp(0)

  tournaments tournaments @relation(fields: [tournament_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  competitors competitors @relation(fields: [competitor_id], references: [user_id], onDelete: Cascade, onUpdate: NoAction)

  robots robots @relation(fields: [robot_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  categories categories @relation(fields: [category_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([category_id])
  @@index([competitor_id])
  @@index([robot_id])
  @@index([tournament_id])
}

model tournaments {
  id          Int       @id @default(autoincrement())
  name        String    @db.VarChar(255)
  description String?   @db.Text
  start_date  DateTime? @db.Date
  end_date    DateTime? @db.Date
  is_active   Boolean?  @default(false)
  created_by  Int?
  created_at  DateTime? @default(now()) @db.Timestamp(0)

  judge_scores             judge_scores[]
  rankings                 rankings[]
  tournament_judges        tournament_judges[]
  tournament_registrations tournament_registrations[]
  tournament_results       tournament_results[]

  createdBy users? @relation("UserCreatedTournaments", fields: [created_by], references: [id], onUpdate: NoAction)

  @@index([created_by])
}

model users {
  id              Int        @id @default(autoincrement())
  name            String     @db.VarChar(255)
  lastName        String     @db.VarChar(255)
  age             Int?       @db.UnsignedTinyInt
  nickname        String     @unique @db.VarChar(100)
  email           String     @unique @db.VarChar(320)
  user_password   String     @db.VarChar(255)
  profile_picture String?    @db.Text
  role            users_role
  is_active       Boolean    @default(true)
  created_at      DateTime?  @default(now()) @db.Timestamp(0)
  updated_at      DateTime?  @default(now()) @db.Timestamp(0)

  judges              judges[]
  news                news[]
  password_resets     password_resets[]
  approvedClubs       clubs[]           @relation("ClubApprovedBy")
  club_owner          club_owners?      @relation("ClubOwnerUser")
  approvedClubOwners  club_owners[]     @relation("ClubOwnerApprovedByAdmin")
  ownedClubs          clubs[]           @relation("UserOwnedClubs")
  competitor          competitors?      @relation("CompetitorUser")
  approvedCompetitors competitors[]     @relation("CompetitorApprovedBy")
  tournaments         tournaments[]     @relation("UserCreatedTournaments")
  blockedHistory      user_blocks[]     @relation("UserBlocked") // Veces que fue bloqueado
  blocksExecuted      user_blocks[]     @relation("UserBlockedByAdmin") // Bloqueos que ejecutó como admin
}

model user_blocks {
  id           Int               @id @default(autoincrement())
  user_id      Int // Usuario que será bloqueado
  blocked_by   Int // Admin que inicia el bloqueo
  reason       String            @db.Text
  status       user_block_status @default(pending)
  blocked_at   DateTime          @default(now()) @db.Timestamp(0)
  unblocked_at DateTime?

  user users @relation("UserBlocked", fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  blockedBy users @relation("UserBlockedByAdmin", fields: [blocked_by], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@index([user_id])
  @@index([blocked_by])
  @@index([status])
}

enum users_role {
  admin
  club_owner
  competitor
  judge
}

enum user_block_status {
  pending
  active
  lifted
}

enum robot_status {
  active
  inactive
  disqualified
  damaged
}

enum robot_control_type {
  autonomous
  remote
  semi_autonomous
}

enum tournament_registrations_validation_status {
  pending
  approved
  rejected
}
